
# ğŸ¦ ì€í–‰ ì°½êµ¬ ë§¤ë‹ˆì € _ ì›°ì‹œì½”ë”©ğŸ¶


## ğŸ“– ëª©ì°¨
ğŸ€ [ì†Œê°œ](#ì†Œê°œ) </br>
ğŸ‘¨â€ğŸ’» [íŒ€ì›](#íŒ€ì›) </br>
â±ï¸ [íƒ€ì„ë¼ì¸](#íƒ€ì„ë¼ì¸) </br>
ğŸ‘€ [ì‹œê°í™”ëœ í”„ë¡œì íŠ¸ êµ¬ì¡°](#ì‹œê°í™”ëœ_í”„ë¡œì íŠ¸_êµ¬ì¡°) </br>
ğŸ’» [ì‹¤í–‰ í™”ë©´](#ì‹¤í–‰_í™”ë©´) </br>
ğŸ§¨ [íŠ¸ëŸ¬ë¸” ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”_ìŠˆíŒ…) </br>
ğŸ“š [ì°¸ê³  ë§í¬](#ì°¸ê³ _ë§í¬) </br>
ğŸ‘¥ [íŒ€ íšŒê³ ](#íŒ€_íšŒê³ ) </br>

</br>

## ğŸ€ ì†Œê°œ<a id="ì†Œê°œ"></a>
í•œ ëª…ì˜ ì§ì›ì„ ê°€ì§„ ì€í–‰ì´ 10 ~ 30ëª…ì˜ ê³ ê°ì„ ë°›ì•„ ì‘ëŒ€í•˜ëŠ” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.

</br>

## ğŸ‘¨â€ğŸ’» íŒ€ì›<a id="íŒ€ì›"></a>
| ğŸ¬WhalesğŸ¬ | ğŸZionğŸ |
| :--------: | :--------: |
| <Img src = "https://hackmd.io/_uploads/BJF3FzK53.png" width="190"> | <Img src = "https://hackmd.io/_uploads/ry9ZHwRt2.png" width="200"> |
|[Github Profile](https://github.com/WhalesJin) |[Github Profile]() |

</br>

## â±ï¸ íƒ€ì„ë¼ì¸<a id="íƒ€ì„ë¼ì¸"></a>
|ë‚ ì§œ|ë‚´ìš©|
|:--:|--|
|2023.07.10| - Node í´ë˜ìŠ¤ ìƒì„± <br> - LinkedList êµ¬ì¡°ì²´ ìƒì„± <br> - LinkedList Test ì§„í–‰ |
|2023.07.11| - Queue êµ¬ì¡°ì²´ ìƒì„± |
|2023.07.12| - Client êµ¬ì¡°ì²´ ìƒì„± <br> - BankManager êµ¬ì¡°ì²´ ìƒì„± <br> - Bank í´ë˜ìŠ¤ ìƒì„± |
|2023.07.13| - ì—…ë¬´ì™„ë£Œ ë©”ì„¸ì§€ ë¡œì§ ì¶”ê°€ <br> - íŒŒì¼ êµ¬ì¡°ì •ë¦¬ |
|2023.07.14| - usleep ë©”ì„œë“œë¥¼ Thread.sleep ë©”ì„œë“œë¡œ ìˆ˜ì • |
|2023.07.15| - WorkType ì¤‘ì²© ì—´ê±°í˜• ìƒì„± |
|2023.07.20| - WorkTypeì„ BankTypeìœ¼ë¡œ ë„¤ì´ë° ìˆ˜ì • ë° íŒŒì¼ ë¶„ë¦¬ <br> - Bank í´ë˜ìŠ¤ì˜ startTask ë©”ì„œë“œê°€ ì€í–‰ ì—…ë¬´ ì¢…ë¥˜ë³„ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì • |

</br>

## ğŸ‘€ ì‹œê°í™”ëœ í”„ë¡œì íŠ¸ êµ¬ì¡°<a id="ì‹œê°í™”ëœ_í”„ë¡œì íŠ¸_êµ¬ì¡°"></a>

### â„¹ï¸ File Tree
    â”Œâ”€â”€ ios-bank-manager
    â”‚Â Â  â”œâ”€â”€ BankManagerConsoleApp
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Model
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Queue
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Node
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ LinkedList
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Queue
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ Bank
    â”‚Â Â  â”‚Â Â  â”‚Â Â   Â Â  â”œâ”€â”€ BankingType
    â”‚Â Â  â”‚Â Â  â”‚Â Â   Â Â  â”œâ”€â”€ Client
    â”‚Â Â  â”‚Â Â  â”‚Â Â   Â Â  â”œâ”€â”€ BankManger
    â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ Bank
    â”‚Â Â  â”‚Â Â  â””â”€â”€ main
    â”‚Â Â  â””â”€â”€ Tests
    â””â”€â”€ README.md

### ğŸ“ Diagram
<p align="center">
    
<img width = "600" src = "https://hackmd.io/_uploads/BkHhdPDc3.png"> <br>

</p>

## ğŸ’» ì‹¤í–‰ í™”ë©´<a id="ì‹¤í–‰_í™”ë©´"></a>
<img src = "https://hackmd.io/_uploads/BJQvBwRFn.gif" width = "450">
</br>
<img src = "https://hackmd.io/_uploads/Bk90PKL52.gif" width = "455">


## ğŸ§¨ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…<a id="íŠ¸ëŸ¬ë¸”_ìŠˆíŒ…"></a>
### 1ï¸âƒ£ `Escaping closure captures mutating 'self' parameter` Error
ğŸš¨ **ë¬¸ì œì ** <br>
Bank Typeì„ structë¡œ ì„¤ì •í•˜ì—¬ Closure ë‚´ë¶€ì—ì„œ Captureì‹œ Closureë‚´ë¶€ì˜ Bankì™€ í´ë¡œì € ì™¸ë¶€ì˜ Bankê°€ ë™ì¼í•˜ì§€ ì•Šì•„ ê²½ê³  ë¬¸êµ¬ê°€ ë…¸ì¶œ ë˜ì—ˆìŠµë‹ˆë‹¤.
<br>

ğŸ’¡ **í•´ê²°ë°©ë²•** <br>
```swift
DispatchQueue.global().async(group: group) {
                self.bankManger.work(client: client)
                semaphore.signal()
            }
```
í˜„ì¬ `Bank Type`ì˜ `startTask` ë¡œì§ ë‚´ë¶€ì—ì„œëŠ” `Bank Type`ì˜ ë‚´ë¶€ ë³€ìˆ˜ì— ì ‘ê·¼í•˜ëŠ” `async`ë¡œì§ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ë”°ë¼ì„œ `Bank Type`ì„ `struct`ë¡œ ì„¤ì •í•˜ê²Œ ëœë‹¤ë©´ `async`ê°€ ë“±ë¡ë  ë•Œì˜ `Bank`ì™€ `async block` ë‚´ì—ì„œ `capture` ë  ë•Œì—ì˜ `Bank`ê°€ ì„œë¡œ ë‹¤ë¥¸ `Bank` ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

ê·¸ ì´ìœ ëŠ” ì¼ë°˜ì ìœ¼ë¡œ í´ë¡œì € ë‚´ì—ì„œ ê°’ì„ ìº¡ì³í–ˆì„ ë•Œì—ëŠ” ê°’ íƒ€ì…ì´ë“  ì°¸ì¡° íƒ€ì…ì´ë“  `Strong Reference` í˜•íƒœë¡œ ê°’ì„ ì°¸ì¡°í•˜ì§€ë§Œ ê°’ íƒ€ì…ì˜ ê²½ìš°ì—ëŠ” ë³µì‚¬ëœ ê°’ì— ëŒ€í•œ ì£¼ì†Œ ê°’ì„ ì°¸ì¡°í•˜ê¸° ë•Œë¬¸ì— `async`ë¡œ ë“±ë¡í•  ë•Œì˜ `Bank`ì™€ ì‹¤ì§ˆì ìœ¼ë¡œ `async block`ì´ ì‹¤í–‰ë  ë•Œì˜ `Bank`ê°€ ê°™ì€ `Bank`ì„ì„ ë³´ì¥í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. 

ë”°ë¼ì„œ `Bank`ë¥¼ `Class` ì°¸ì¡° íƒ€ì…ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. ë˜í•œ `Strong Reference` ì°¸ì¡°ë¥¼ í•˜ê²Œëœë‹¤ë©´ ìˆœí™˜ì°¸ì¡°ì˜ ê°€ëŠ¥ì„±ì—ëŒ€í•´ ê³ ë¯¼í•´ë´¤ì§€ë§Œ ìœ„ì™€ ê°™ì€ ê²½ìš°ì—ì„œëŠ” `async block`ì—ì„œëŠ” `Bank`ë¥¼ ì°¸ì¡°í•˜ê³  ìˆì§€ë§Œ `Bank`ì—ì„œëŠ” í•´ë‹¹ `async block`ì„ ì§ì ‘ì ìœ¼ë¡œ ì°¸ì¡°í•˜ê³  ìˆì§€ì•Šìœ¼ë¯€ë¡œ ìˆœí™˜ì°¸ì¡°ê°€ ë°œìƒí•˜ì§€ì•Šê¸° ë•Œë¬¸ì— `[weak self]`ì˜ ìº¡ì³í‚¤ì›Œë“œëŠ” ìƒëµí–ˆìŠµë‹ˆë‹¤.

<br>

### 2ï¸âƒ£ `DispatchQueue vs OperationQueue`
ğŸš¨ **ë¬¸ì œì ** <br>
DispatchQueueì™€ OpeartionQueue ì¤‘ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í• ì§€ ê³ ë¯¼í–ˆìŠµë‹ˆë‹¤.
<br>

ğŸ’¡ **í•´ê²°ë°©ë²•** <br>
OperationQueueë¥¼ í™œìš©í•˜ì—¬ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

`DispatchQueue`ì„ í™œìš©í•´ í•´ë‹¹ ìš”êµ¬ì‚¬í•­ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ìœ¼ë¡œëŠ” `DispatchGroup` ë° `DispatchSemaphore`ë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•ì´ ìˆì—ˆê³  `OperationQueue`ë¥¼ í™œìš©í•œë‹¤ë©´ `maxConcurrentOperationCount` property ë° `waitUntilAllOperationsAreFinished` ë©”ì„œë“œì˜ í™œìš©ìœ¼ë¡œ ê³¼ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

`Thread`ìƒì„±ì„ ì§ì ‘ì ìœ¼ë¡œ ì œí•œí•  ìˆ˜ ìˆëŠ” `DispatchSemaphore`ì„ ì‚¬ìš©í•˜ì—¬ ì“°ë ˆë“œì˜ ìƒì„±ê¹Œì§€ ê°ì²´ì§€í–¥ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” `DispatchQueue`ë¥¼ ì‚¬ìš©í•˜ë ¤ í–ˆìŠµë‹ˆë‹¤ë§Œ, `MainThread`ë¥¼ ë©ˆì¶”ì§€ ì•Šê³  `Semaphore`ë¥¼ `wait`í•˜ê¸° ìœ„í•´ì„œëŠ” ë˜ ë‹¤ë¥¸ `Thread`ê°€ í•„ìš”í•˜ë‹¤ëŠ” ì‚¬ì‹¤ì„ ì•Œê²Œ ë˜ì—ˆê³  ì´ë ‡ê²Œ êµ¬í˜„í•œë‹¤ë©´ ì›ë˜ì˜ ì˜ë¯¸ê°€ í‡´ìƒ‰ëœë‹¤ê³  ìƒê°í–ˆê¸° ë•Œë¬¸ì— ì‚¬ìš©í•˜ê¸°ë„ ì‰½ê³  `cancel`ì— ëŒ€í•œ ë™ì‘ë„ ì‰¬ìš´ `Operation Queue`ë¥¼ í†µí•´ ë™ì‘ êµ¬í˜„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.

<details>
    <summary> DispatchQueue ì½”ë“œ </summary>
    
```swift
private func startTask() {
    let group = DispatchGroup()
    let clientCount = Int.random(in: 10...30)
    let startTime = Date()
    let depositSemaphore = DispatchSemaphore(value: depositBankManagerCount)
    let loanSemaphore = DispatchSemaphore(value: loanBankManagerCount)
    var workSemaphore: DispatchSemaphore

    setUpClientQueue(count: clientCount)

    while !clientQueue.isEmpty {
        guard let client = clientQueue.dequeue() else { break }
        workSemaphore = client.banking == .deposit ? depositSemaphore : loanSemaphore

        workSemaphore.wait()
        DispatchQueue.global().async(group: group) {
            self.bankManger.work(client: client)
            workSemaphore.signal()
        }
    }

    group.wait()
    printTaskResult(clientCount, startTime)
    open()
}
```
</details>
</br>

í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë‹¤ë³´ë‹ˆ ì½˜ì†”ì°½ì˜ ìŠ¤ë ˆë“œ ë™ì‘ì´ ìš”êµ¬ì‚¬í•­ê³¼ ë§ì§€ ì•Šê²Œ ì‘ë™í•˜ëŠ” ê²ƒì„ ë³´ê³  `DispatchQueue`ì˜ í•œê³„ë¥¼ ëŠê»´ `Operation`ìœ¼ë¡œ ë‹¤ì‹œ ì‘ì—…ì˜ ë°©í–¥ì„ ë°”ê¾¸ì—ˆìŠµë‹ˆë‹¤.

<details>
    <summary> OperationQueue ì½”ë“œ </summary>
    
```swift
private func startTask() {
    let clientCount = Int.random(in: 10...30)
    let startTime = Date()
    let depositOperationQueue = OperationQueue()
    let loanOperationQueue = OperationQueue()
    var operationQueue: OperationQueue
    var operation: BlockOperation

    depositOperationQueue.maxConcurrentOperationCount = depositBankManagerCount
    loanOperationQueue.maxConcurrentOperationCount = loanBankManagerCount
    setUpClientQueue(count: clientCount)

    while !clientQueue.isEmpty {
        guard let client = clientQueue.dequeue() else { break }

        operation = BlockOperation { self.bankManger.work(client: client) }
        operationQueue = client.banking == .deposit ? depositOperationQueue : loanOperationQueue
        operationQueue.addOperation(operation)
    }

    depositOperationQueue.waitUntilAllOperationsAreFinished()
    loanOperationQueue.waitUntilAllOperationsAreFinished()
    printTaskResult(clientCount, startTime)
    open()
}
```
</details>

ë¬¼ë¡  ê°™ì€ ê²°ê³¼ë¬¼ì„ ë‚˜íƒ€ëƒˆê² ì§€ë§Œ ì¡°ê¸ˆ ë” ê°ì²´ì§€í–¥ì— ëŒ€í•´ì„œ ê³ ë¯¼í•´ë³¼ ìˆ˜ ìˆì–´ì„œ ì¢‹ì•˜ìŠµë‹ˆë‹¤.

<br>

### 3ï¸âƒ£ ê°’ íƒ€ì…ì´ `Mutating`ì´ ë  ë•Œ ìˆ˜ì •ëœ ê°’ìœ¼ë¡œ ì¬í• ë‹¹ì´ ì´ë¤„ì§€ëŠ”ê°€
ğŸš¨ **ë¬¸ì œì ** <br>
ê°’ íƒ€ì…ì—ì„œ `Mutating` í‚¤ì›Œë“œê°€ ë¶™ì„ ë•Œ ì¦‰, íƒ€ì… ë‚´ë¶€ì—ì„œì˜ ê°’ì´ ìˆ˜ì •ë˜ì—ˆì„ ë•Œ ì‹¤ì§ˆì ìœ¼ë¡œ ë©”ëª¨ë¦¬ì— ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ëŠ” ë°©ì‹ì„ ê³ ë¯¼í–ˆìŠµë‹ˆë‹¤.
</br>

ğŸ’¡ **í•´ê²°ë°©ë²•** </br>
`Mutating`ì„ ë‚˜íƒ€ë‚´ëŠ” ê³µì‹ë¬¸ì„œì—ì„œëŠ” 
> The method can then mutate (that is, change) its properties from within the method, and any changes that it makes are written back to the original structure when the method ends. The method can also assign a completely new instance to its implicit self property, and this new instance will replace the existing one when the method ends.

ìœ„ì™€ ê°™ì´ í‘œí˜„ë˜ì–´ìˆì§€ë§Œ í•´ë‹¹ ê¸€ë§Œìœ¼ë¡œëŠ” í™•ì‹¤íˆ `mutating`ì´ ìˆ˜ì •ëœ ê°’ì„ ë°˜ë“œì‹œ ì¬í• ë‹¹í•˜ëŠ” ì§€ì— ëŒ€í•œ ë‹µì´ ì¶©ë¶„íˆ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¡°ê¸ˆì€ ì• ë§¤í•œ í‘œí˜„ì´ì—ˆë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì¡°ê¸ˆë” í•´ë‹¹ ê´€ë ¨ ì§€ì‹ì— í™•ì‹ ì„ ì¤„ ìˆ˜ ìˆëŠ” ìë£Œë¥¼ ì°¾ì•„ë³´ë˜ ì¤‘ https://github.com/apple/swift/blob/main/docs/MutationModel.rst
`swift`ì˜ `openSource`ì— ë‚˜ì™€ìˆëŠ” ìë£Œë¥¼ ì°¾ê²Œ ë˜ì—ˆê³  ê·¸ ê²°ê³¼
> The implicit self parameter of a struct or enum method is semantically an inout parameter if and only if the method is attributed with mutating. Read-only methods do not "write back" onto their target objects.

`mutating`ì´ ë°œìƒí•˜ëŠ” `ê°’ íƒ€ì…(struct, enum)`ì€ ëª…ì‹œì ìœ¼ë¡œ `inout` í‚¤ì›Œë“œê°€ ë¶™ëŠ”ë‹¤.

ë”°ë¼ì„œ `inout`ì˜ ê²½ìš°
> In-out parameters are passed as follows:
> 1. When the function is called, the value of the argument is copied.
> 2. In the body of the function, the copy is modified.
> 3. When the function returns, the copyâ€™s value is assigned to the original argument.

í•´ë‹¹ ìˆœì„œë¡œ ìˆ˜ì •ëœ ê°’ì„ ì¬í• ë‹¹ í•˜ê³  ìˆìœ¼ë¯€ë¡œ `ê°’íƒ€ì…(struct, enum)` ë˜í•œ ìˆ˜ì •ëœ ê°’ì„ ì¬í• ë‹¹í•œë‹¤ëŠ” ê²°ë¡ ì„ ì–»ì—ˆìŠµë‹ˆë‹¤.

<br>

### 4ï¸âƒ£ BankingType ìœ„ì¹˜
ğŸš¨ **ë¬¸ì œì ** <br>
- ì²˜ìŒ step3 êµ¬í˜„ì„ í•  ë•ŒëŠ” `Client` íƒ€ì…ì´ ì€í–‰ ì—…ë¬´ë¥¼ ì•Œê³  ìˆì–´ì•¼ í•œë‹¤ê³  íŒë‹¨í•˜ì—¬ `Client` íƒ€ì…ì˜ ì¤‘ì²©íƒ€ì…ìœ¼ë¡œ `BankingType`ì„ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.
```swift
struct Client {
    enum BankingType: String, CaseIterable {
        case deposit = "ì˜ˆê¸ˆ"
        case loan = "ëŒ€ì¶œ"

        var taskTime: Double {
            switch self {
            case .deposit:
                return 0.7
            case .loan:
                return 1.1
            }
        }
    }

    let turn: Int
    let banking: BankingType

    init(_ turn: Int, _ bankingType: BankingType) {
        self.turn = turn
        self.banking = bankingType
    }
}
```
<br>

ğŸ’¡ **í•´ê²°ë°©ë²•** <br>

- í•˜ì§€ë§Œ ê°ì²´ ì§€í–¥ì ìœ¼ë¡œ í˜„ì‹¤ ì„¸ê³„ì™€ ì ‘ëª©ì‹œì¼œ ìƒê°í–ˆì„ ë•Œ, ì€í–‰ì—…ë¬´ë¥¼ ê³ ê°(`Client`)ê³¼ ì€í–‰ì›(`BankManager`) ëª¨ë‘ ì•Œì•„ì•¼í•œë‹¤ê³  ìƒê°í–ˆê³ , `work` ë©”ì„œë“œë¥¼ êµ¬í˜„í•˜ëŠ” ì¤‘ì—ë„ í•„ìš”í•˜ë‹¤ê³  ìƒê°í•˜ì—¬ íŒŒì¼ë¶„ë¦¬ë¥¼ í•´ì„œ ë”°ë¡œ ì—´ê±°í˜•ìœ¼ë¡œ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.
```swift
enum BankingType: String, CaseIterable {
    case deposit = "ì˜ˆê¸ˆ"
    case loan = "ëŒ€ì¶œ"

    var taskTime: Double {
        switch self {
        case .deposit:
            return 0.7
        case .loan:
            return 1.1
        }
    }
}
```    

<br>


### 5ï¸âƒ£ `taskTime`ì˜ ìœ„ì¹˜
ğŸš¨ **ë¬¸ì œì ** <br>
- `taskTime` í”„ë¡œí¼í‹°ëŠ” ì—…ë¬´ ì†Œìš”ì‹œê°„ìœ¼ë¡œ ê°ì²´ ì§€í–¥ì ìœ¼ë¡œ ë‘ê°€ì§€ ë°©í–¥ì„ ê³ ë¯¼í•˜ì˜€ìŠµë‹ˆë‹¤.
    - í•´ë‹¹ ì¼ì„ ìˆ˜í–‰í•˜ëŠ” ê°ì²´ëŠ” `BankManager`ì´ë¯€ë¡œ `BankManager`ê°€ ì—…ë¬´ ì†Œìš” ì‹œê°„ì„ ê°€ì§€ê³  ìˆëŠ” ê²ƒì´ ì¢€ ë” ê°ì²´ì§€í–¥ì ìœ¼ë¡œ ì˜³ì€ ì„¤ê³„ê°€ ì•„ë‹ê¹Œ?
    - ê°™ì€ ì—…ë¬´ë¼ í•˜ë”ë¼ë„ ì€í–‰ë³„ë¡œ ì ˆì°¨ê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ì •í•´ì§„ ìˆœì„œëŒ€ë¡œ ì¼ì„ í•˜ë©´ `BankManager`ê°€ ë‹¤ë¥´ë”ë¼ë„ ê°™ì€ ì—…ë¬´ë¼ë©´ ì†Œìš” ì‹œê°„ì´ ê°™ì„ ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ?

<br>

ğŸ’¡ **í•´ê²°ë°©ë²•** <br>
- ë‘ ê°€ì§€ ì˜ê²¬ ë‹¤ ê·¼ê±°ê°€ ì¶©ë¶„í•˜ë‹¤ê³  ìƒê°ì´ ë˜ì–´ ê³ ë¯¼í•˜ë‹¤ê°€ ìƒì˜ ëì—, í˜„ì¬ í”„ë¡œì íŠ¸ëŠ” í›„ìë¡œ ì„ íƒí•˜ì—¬ ì§„í–‰í•˜ì˜€ìŠµë‹ˆë‹¤.
<br>


### 6ï¸âƒ£ `BankOpenable` í”„ë¡œí† ì½œì˜ ìœ ë¬´
ğŸš¨ **ë¬¸ì œì ** <br>

- Bank í´ë˜ìŠ¤ì˜ open ë©”ì„œë“œëŠ” ëª¨ë“  ì€í–‰ì´ ê°€ì§€ê³  ìˆëŠ” ê¸°ëŠ¥ì´ê¸° ë•Œë¬¸ì— í”„ë¡œí† ì½œ ê¸°ë³¸ êµ¬í˜„ì„ ì´ìš©í•´ë³¼ê¹Œ ê³ ë¯¼í–ˆìŠµë‹ˆë‹¤.
    ```swift
    // Bank
    protocol BankOpenable {
        func openOrClose()
        func openBanking()
    }

    extension BankOpenable {
        func openOrClose() {
            print("1 : ì€í–‰ê°œì \n2 : ì¢…ë£Œ\nì…ë ¥", terminator: " : ")
            let input = readLine()

            switch input {
            case "1":
                openBanking()
            default:
                return
            }
        }
    }

    // main
    let weatherBank: BankOpenable = Bank()
    weatherBank.openOrClose()
    ```
    ì´ë ‡ê²Œ ì“°ê²Œ ëœë‹¤ë©´ `weatherBank`ëŠ” `BankOpenable`ì—ì„œ êµ¬í˜„í•˜ë¼ê³  ëª…ì‹œí•´ì£¼ì—ˆë˜ `openOrClose`ì™€ `openBanking` ë©”ì„œë“œë§Œ ì•Œê³  ìˆê²Œë˜ê³ , êµ¬ì²´ì  íƒ€ì…ì— ì˜ì¡´í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ ì¶”ìƒì ì¸ í”„ë¡œí† ì½œì— ì˜ì¡´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰, ì±„íƒí•  ìˆ˜ ìˆëŠ” ê°ì²´ë¼ë©´ ì–´ë–¤ ê²ƒì´ë“  ëŒ€ì²´ë  ìˆ˜ ìˆìœ¼ë©´ í…ŒìŠ¤í„°ë¸”í•˜ê³  ìœ ì—°í•œ ì½”ë“œê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
<br>

ğŸ’¡ **í•´ê²°ë°©ë²•** <br>

- í•˜ì§€ë§Œ `openOrClose` ë©”ì„œë“œê°€ `openBanking` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ë¶ˆí•„ìš”í•œ `openBanking` ë˜í•œ í”„ë¡œí† ì½œì´ ê°€ì§€ê³  ìˆê²Œ ë˜ë©´ì„œ `main`ì´ `openBanking`ì„ ì•Œê³  ìˆì–´ì•¼ë§Œ í•˜ëŠ” ì¶”ìƒí™”ê°€ ëœ ëœ ë“¯í•œ, ë¶ˆí•„ìš”í•œ ì ‘ê·¼ì´ ëŠê»´ì ¸ í”„ë¡œí† ì½œ êµ¬í˜„ì„ ì‚­ì œí•˜ì˜€ìŠµë‹ˆë‹¤.

<br>

### 7ï¸âƒ£ Semaphoreê°€ Main Threadë¥¼ ë©ˆì¶œ ìˆ˜ ìˆë„ë¡ ì„¤ê³„ëœ ê²½ìš°
ğŸš¨ **ë¬¸ì œì ** <br>
- `DispatchSemapthore`ê°€ ì˜ë„ì¹˜ ì•Šê²Œ `MainThread`ë¥¼ ë©ˆì¶¤ìœ¼ë¡œì¨ ì›í•˜ëŠ” ë™ì‘ì„ ì–»ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.

```swift
workSemaphore = client.banking == .deposit ? depositSemaphore : loanSemaphore
// Main Thread
workSemaphore.wait()
DispatchQueue.global().async(group: group) {
    self.bankManger.work(client: client)
    workSemaphore.signal()
}
```

ë¨¼ì € ìœ„ì˜ ì½”ë“œì˜ ì˜ë„ëŠ” ë°˜ë³µì ìœ¼ë¡œ ë“±ë¡ë˜ëŠ” `async` ë™ì‘ì— ëŒ€í•œ ì¤‘ë³µì½”ë“œë¥¼ ì¤„ì´ê³  ìƒì„±ëœ ì“°ë ˆë“œì˜ ê°¯ìˆ˜ë¥¼ ì œí•œí•˜ê¸° ìœ„í•¨ì´ì˜€ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ê°€ì¥ í° ë¬¸ì œëŠ” `semaphoreë¥¼` `loanê³¼` `depositì„` ë²ˆê°ˆì•„ê°€ë©´ì„œ ì‚¬ìš©í•˜ê²Œ ëœë‹¤ëŠ” ì ì…ë‹ˆë‹¤. `Captureì‹œ` ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ê¸°ë³¸ í˜•íƒœëŠ” `Strong Reference` ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ë¯€ë¡œ ì‚¬ìš©í•˜ê²Œ ë  íƒ€ì´ë°ì—ì„œì˜ `semaphoreê°€` `loan`ì¸ì§€ `deposit`ì¸ì§€ ì•Œ ìˆ˜ê°€ ì—†ë‹¤ëŠ” ì¹˜ëª…ì ì¸ ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ìƒê¸° ì´ìœ ë¡œ í•˜ì—¬ê¸ˆ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

ë˜í•œ, ì²« ì‹œë„ì‹œ ë°˜ë“œì‹œ ì˜ˆê¸ˆ2, ëŒ€ì¶œ1  ì‘ì—…ì´ ë™ì‹œì— ì¼ì„ ì‹œì‘í•˜ì§€ ì•ŠëŠ” ë‹¨ì  ë˜í•œ ê°€ì§€ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ë‹¨ì ì´ ì™œ ë°œìƒí•˜ëŠ”ì§€ ë¶„ì„ ì¤‘ `Queue`ë¥¼ 2ê°œë¡œ ì‘ì—…í–ˆì„ ë•Œë„ ë™ì¼í•œ ê²°ê³¼ë¥¼ ë‚˜íƒ€ëƒˆìŠµë‹ˆë‹¤.

```swift
/// Main Thread
if client.banking == .deposit {
    depositSemaphore.wait()
    DispatchQueue.global().async(group: group) {
        self.bankManger.work(client: client)
        depositSemaphore.signal()
    }
} else {
    loanSemaphore.wait()
    DispatchQueue.global().async(group: group) {
        self.bankManger.work(client: client)
        loanSemaphore.signal()
    }
}
```

ìœ„ì˜ ì½”ë“œëŠ” ì²«ë²ˆì§¸ì™€ ê°™ì´ `semaphore`ë¥¼ í˜¼ë™í•´ì„œ ì‚¬ìš©í•˜ëŠ” ì´ìŠˆëŠ” ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ë§Œ ì²« ì‹œë„ì‹œ ì¢…ì¢… ì˜ˆê¸ˆ2, ëŒ€ì¶œ1 ì´ ë™ì‹œì— ì‘ì—…ì„ ì‹œì‘í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ë¬¸ì œë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. 

<br>

ğŸ’¡ **í•´ê²°ë°©ë²•** <br>

ê·¸ ì´ìœ ë¥¼ ë¶„ì„í•œ ê²°ê³¼, í˜„ì¬ ìƒì„±ë˜ëŠ” `process`ì˜ ê°¯ìˆ˜ë¥¼ ë§‰ê¸° ìœ„í•´ì„œ `async Block` ì™¸ë¶€ì— `semaphore`ë¥¼ ì‚½ì…í•˜ì—¬ ìƒì„±ë˜ëŠ” `Thread`ì˜ ê°¯ìˆ˜ë¥¼ ì œí•œí–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì²« ì‘ì—…ì‹œ ëŒ€ì¶œ, ëŒ€ì¶œ ì´ ì—°ì†ì ìœ¼ë¡œ ë“¤ì–´ì˜¬ ê²½ìš° ëŒ€ì¶œì— ëŒ€í•œ `semaphore`ê°€ 1ë¡œ ì¡´ì¬í•˜ë¯€ë¡œ ì²«ë²ˆì§¸ ëŒ€ì¶œì— ëŒ€í•œ `Thread`ìƒì„± ì´í›„ ë” ëŒ€ì¶œì— ëŒ€í•œ ì‘ì—…í•  ìˆ˜ ìˆëŠ” `semaphore`ì˜ ìˆ˜ê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ `MainThread` ìì²´ë¥¼ ë©ˆì¶°ë²„ë ¤ì„œ ë‹¤ë¥¸ ì‘ì—…ë“¤ì´ ë“±ë¡ë˜ì§€ ëª»í•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ì•Œê²Œë˜ì—ˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ ëŒ€ì¶œì´ ì—°ì†ì ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²½ìš° ì›í•˜ëŠ” ë™ì‘ì„ í•˜ì§€ ì•Šì•˜ê³  ê·¸ ë°–ì˜ ê²½ìš°ì—ì„œëŠ” ì›í•˜ëŠ” ë™ì‘ì„ í–ˆì—ˆìŠµë‹ˆë‹¤.

ì›ì´ˆì ì¸ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì—¬ ì½”ë“œë¥¼ ì¡°ê¸ˆ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.

```swift
group.enter()
DispatchQueue.global().async {
    if client.banking == .deposit {
        depositSemaphore.wait()
        DispatchQueue.global().async(group: group) {
            self.bankManger.work(client: client)
            depositSemaphore.signal()
            group.leave()
        }
    } else {
        loanSemaphore.wait()
        DispatchQueue.global().async(group: group) {
            self.bankManger.work(client: client)
            loanSemaphore.signal()
            group.leave()
        }
    }
}

```

ìš°ì„  ì²˜ìŒ ì§‘ì¤‘í•´ë³¸ ë¶€ë¶„ì€ `group`ì—ì„œì˜ `enter`, `leave`ì˜ ì‚¬ìš©ì´ì—ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ 2ë²ˆì§¸ë¡œ ì–¸ê¸‰ë“œë ¸ë˜ ì½”ë“œì²˜ëŸ¼ ì •ë§ ì¤‘ìš”í•˜ê²Œ ì´ìŠˆì˜ ì›ì¸ì´ ë˜ì—ˆë˜ ë¶€ë¶„ì€ mainì„ ë©ˆì¶œ ìˆ˜ ìˆëŠ” ë™ì‘ì´ ì¡´ì¬í•œë‹¤ëŠ” ì ì´ ì—ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ 2ê°œì˜ `async block`ì„ í•œë²ˆë” `async block`ìœ¼ë¡œ ê°ì‹¸ì„œ ëŒ€ì¶œì´ ì¤‘ë³µìœ¼ë¡œ ë“¤ì–´ì™€ì„œ `wait`ë˜ëŠ” ìƒí™©ì´ ì˜¤ë”ë¼ë„ `main`ì´ `wait`í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ë“±ë¡ëœ `Thread`ë¥¼ `wait`ì‹œì¼œì„œ ì´ì™¸ì˜ ë™ì‘ë“¤ì€ ë˜ë‹¤ë¥¸ `Thread`ì— í• ë‹¹ë˜ì–´ ì •ìƒë™ì‘í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„í–ˆê³ , ì´ë¥¼ ì œê°€ ì›ë˜ ì ìš©í–ˆë˜ ì½”ë“œ ìŠ¤íƒ€ì¼ë¡œ ì¡°ê¸ˆ ë‹¤ë“¬ì€ ê²°ê³¼

```swift
DispatchQueue.global().async(group: group) {
    if client.banking == .deposit {
        depositSemaphore.wait()
        DispatchQueue.global().async(group: group) {
            self.bankManger.work(client: client)
            depositSemaphore.signal()
        }
    } else {
        loanSemaphore.wait()
        DispatchQueue.global().async(group: group) {
            self.bankManger.work(client: client)
            loanSemaphore.signal()
        }
    }
}

```

ì›ë˜ ì‚¬ìš©í–ˆë˜ `group`ì˜ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆì—ˆê³  ì´ìŠˆë¥¼ í•´ê²°í•˜ì—¬ ì›í•˜ëŠ” ë™ì‘ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ `DispatchSemaphore`ë¥¼ ì‚¬ìš©í•  ë•Œ í•´ë‹¹ `semaphore`ê°€ `Main Thread`ë¥¼ `wait` ì‹œí‚¬ ìˆ˜ ìˆëŠ” ê²½ìš°ì˜ ìˆ˜ë¥¼ ìƒê°í•´ë³´ê³  ì‚¬ìš©í•´ì•¼í•©ë‹ˆë‹¤.


<br>

## ğŸ“š ì°¸ê³  ë§í¬<a id="ì°¸ê³ _ë§í¬"></a>

- [ğŸApple Docs: DispatchSemaphore](https://developer.apple.com/documentation/dispatch/dispatchsemaphore)
- [ğŸApple Docs: Thread Sleep](https://developer.apple.com/documentation/foundation/thread/1413673-sleep)
- [ğŸApple Docs: ModifyingValueTypes](https://docs.swift.org/swift-book/documentation/the-swift-programming-language/methods/#Modifying-Value-Types-from-Within-Instance-Methods)
- [ğŸApple Docs: functions - InOutParameters](https://docs.swift.org/swift-book/documentation/the-swift-programming-language/functions/#In-Out-Parameters)
- [ğŸApple Docs: declarations - InOutParameters](https://docs.swift.org/swift-book/documentation/the-swift-programming-language/declarations/#In-Out-Parameters)
- <Img src = "https://github.com/WhalesJin/ios-bank-manager/assets/124643545/d1df2d8a-6667-438d-9643-aab8a83a4754" width="20"/> [Apple Github: MutationModel](https://github.com/apple/swift/blob/main/docs/MutationModel.rst)
- <Img src = "https://github.com/mint3382/ios-calculator-app/assets/124643545/56986ab4-dc23-4e29-bdda-f00ec1db809b" width="20"/> [ì•¼ê³°ë‹·ë„·: ë™ì‹œì„±í”„ë¡œê·¸ë˜ë°](https://yagom.net/courses/ë™ì‹œì„±-í”„ë¡œê·¸ë˜ë°-concurrency-programming/lessons/ë™ì‹œì„±-í”„ë¡œê·¸ë˜ë°/)
- <Img src = "https://hackmd.io/_uploads/ByTEsGUv3.png" width="20"/> [blog: StrongReferenceCycle](https://medium.com/@LeeZion94/strong-reference-cycle-8a88bdd8424b)


</br>

## ğŸ‘¥ íŒ€ íšŒê³ <a id="íŒ€_íšŒê³ "></a>
- [íŒ€ íšŒê³  ë§í¬](https://github.com/WhalesJin/ios-bank-manager/wiki/ğŸ¦-ì€í–‰-ì°½êµ¬-ë§¤ë‹ˆì €_ì›°ì‹œì½”ë”©ğŸ¶)
